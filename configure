#!/bin/sh

os=`uname`
mac=`uname -m`
as=""

usage() {
	sed -e 's/^.//' <<EOT
	Usage: $0 [-h] [-m cpu] [-s os]
EOT
}

longusage() {
	echo
	usage
	echo
	sed -e 's/^.//' <<EOT
	-m mac   select target machine
	-s os    select target operating system

EOT
}

while [ "x$1" != "x" ]; do
	case $1 in
	-h)	longusage; exit ;;
	-m)	shift
		if [ "x$1" = "x" ]; then usage; exit; fi
		mac=$1
		;;
	-s)	shift
		if [ "x$1" = "x" ]; then usage; exit; fi
		os=$1
		;;
	*)	usage; exit ;;
	esac
	shift
done

if test -f src/scc0; then
	echo "You may want to run 'make clean' first."
	exit 1
fi

case $os/$mac in
FreeBSD/i386)		os=freebsd ; mac=386    ; int=32 ;;
FreeBSD/amd64)		os=freebsd ; mac=x86-64 ; int=64 ;;
NetBSD/amd64)		os=netbsd  ; mac=x86-64 ; int=64 ;;
Linux/i386)		os=linux   ; mac=386    ; int=32 ;;
Linux/i686)		os=linux   ; mac=386    ; int=32 ;;
Linux/x86_64)		os=linux   ; mac=x86-64 ; int=64 ;;
MINGW32_NT-6.1/i686)	os=windows ; mac=386    ; int=32 ;;
MINGW32_NT-5.1/i686)	os=windows ; mac=386    ; int=32 ;;
windows/386)		os=windows ; mac=386    ; int=32 ;;
DOS/8086)		os=dos     ; mac=8086   ; int=16
			as=s86
			ar="sar -c"
			ranlib="sar -r"
			echo
			echo "WARNING: this port is not yet finished!"
			echo
			;;
*)			echo "Sorry, $os/$mac is currently not supported."
			exit 1
			;;
esac

if [ -f src/targets/cg$mac-syn.c ]; then
	gen=syn
elif [ -f src/targets/cg$mac-stk.c ]; then
	gen=stk
else
	echo "oops, no back-end available for $mac/$os?"
	exit 1
fi

if [ $os = windows ]; then
	cp src/Makefile.windows src/Makefile
	(cd src; ln -fs ../targets/init-windows.c lib/init.c)
	(cd src; ln -fs ../targets/system-windows.c lib/system.c)
else
	if [ "$as" != "" ]; then
		sed	-e "s/^AS=.*/AS=	$as/" \
			-e "s/^AR=.*/AR=	$ar/" \
			-e "s/^RANLIB=.*/RANLIB=	$ranlib/" \
		<src/Makefile.unix >src/Makefile
	else
		cp src/Makefile.unix src/Makefile
	fi
	(cd src; ln -fs ../targets/init-unix.c lib/init.c)
	(cd src; ln -fs ../targets/system-unix.c lib/system.c)
fi

(cd src && ln -fs targets/cg$mac-$gen.c cg.c)
(cd src && ln -fs targets/cg$mac.h cg.h)
(cd src && ln -fs targets/${gen}gen.c gen.c)
(cd src && ln -fs targets/$os.h sys.h)
(cd src/lib && ln -fs ../targets/crt0-$os-$mac.s crt0.s)
(cd src/include && ln -fs ../targets/limits-$int.h limits.h)

echo "Building for $os/$mac. Now cd to src and run make."
