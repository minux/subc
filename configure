#!/bin/sh

os=`uname`
mac=`uname -m`
gen=stk

if [ "x$1" = "x-syn" ]; then
	gen=syn
fi

if test -f src/scc0; then
	echo "You may want to run 'make clean' first."
	exit 1
fi

case $os/$mac in
FreeBSD/i386)	os=freebsd ; mac=386    ; int=32 ;;
FreeBSD/amd64)	os=freebsd ; mac=x86-64 ; int=64 ;;
NetBSD/amd64)	os=netbsd  ; mac=x86-64 ; int=64 ;;
Linux/i386)	os=linux   ; mac=386    ; int=32 ;;
Linux/i686)	os=linux   ; mac=386    ; int=32 ;;
Linux/x86_64)	os=linux   ; mac=x86-64 ; int=64 ;;
*)
	echo "Sorry, $os/$mac is currently not supported."
	exit 1
	;;
esac

if [ $gen = syn -a ! -f src/targets/cg$mac-$gen.c ]; then
	echo "Sorry, there is no synthesizing back-end for $os/$mac."
	echo "Please try the naive code generator."
	exit 1
fi

(cd src && ln -fs targets/cg$mac-$gen.c cg.c)
(cd src && ln -fs targets/cg$mac.h cg.h)
(cd src && ln -fs targets/${gen}gen.c gen.c)
(cd src/lib && ln -fs ../targets/crt0-$os-$mac.s crt0.s)
(cd src/include && ln -fs ../targets/limits-$int.h limits.h)

echo "Building for $os/$mac. Now cd to src and run make."
